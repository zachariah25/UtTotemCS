<!DOCTYPE html>

<html lang="en">
<head>
	<!-- Mobile Specific Metas
  ================================================== -->
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<!-- CSS
  ================================================== -->
	<link rel="stylesheet" href="stylesheets/base.css">
	<link rel="stylesheet" href="stylesheets/skeleton.css">
	<link rel="stylesheet" href="stylesheets/layout.css">

	<link href="jquery-ui.css" rel="stylesheet" type="text/css">
	<link href="style.css" rel="stylesheet" type="text/css">

	<title>Recursion Editor</title>
	<script src="jquery.js"></script>
	<script src="jquery-ui.js"></script>
  	
	<script>
	$(function() {
	    $(".draggable").draggable({
	        connectToSortable: "#selectedList",
	        helper: "clone",
	        revert: "invalid"
	    });
	    $("#selectedList").sortable({
	        over: function () {
                removeIntent = false;
            },
            out: function () {
                removeIntent = true;
            },
            beforeStop: function (event, ui) {
                if(removeIntent == true){
                    ui.item.remove();   
                }
            },
            stop: function() {
            	if ($("#autoDraw").is(':checked')) {
            		drawOnCanvas();
            	}
            }
	    }).droppable({greedy: true});
	    $("ul, li").disableSelection();
	});

	$(function() {
		$( "#slider-range-min" ).slider({
		  range: "min",
		  value: 4,
		  min: 1,
		  max: 15,
		  slide: function( event, ui ) {
		    $( "#amount" ).val( ui.value );
		    if ($("#autoDraw").is(':checked')) {
            	drawOnCanvas();
            }
		  },
		  change: function( event, ui) {
		  	if ($("#autoDraw").is(':checked')) {
            	drawOnCanvas();
            }
		  }
		});
		$( "#amount" ).val( $( "#slider-range-min" ).slider( "value" ) );
	});

	// draw initial set of commands after page loads
	$(document).ready(function () {
		drawOnCanvas();
		saveCustomDrawing();
	});

  	</script>
</head>
<body>


<div class="container">
	<p><h1>Write your own recursion!</h1></p>

    <div class="one-third column">
    	<p><h2>Available commands</h2></p>
    	<ul id="commandList" class="connectedSortable"></ul>
    </div>
    <div class="one-third column">
    	<p><h2>Drag commands here</h2></p>
    	<ul id="selectedList" class="connectedSortable">
  			<li class="ui-state-default">forward</li>
  			<li class="ui-state-default">left 45 degrees</li>
  			<li class="ui-state-default">recurse</li>
  			<li class="ui-state-default">right 90 degrees</li>
  			<li class="ui-state-default">recurse</li>
  			<li class="ui-state-default">left 45 degrees</li>
  			<li class="ui-state-default">backward</li>
		</ul>
		
	</div>
    <div class="one-third column">
    	<p><h2>Run it!</h2></p>

		<p>

		<label for="autoDraw">
      		<input type="checkbox" id="autoDraw" value="autoDraw" checked/>
      		<span>Automatically draw</span>
    	</label>

		<label for="amount">Recursion depth:</label>
		<input type="text" id="amount" style="border:0; color:#f6931f; font-weight:bold;">
		</p>

		<div id="slider-range-min"></div>

    	<br><br>
    	<button onclick="drawOnCanvas()" class="full-width button">Run it!</button>
    	<button onclick="animateDrawOnCanvas()" class="full-width button">Super run it!</button>
    	<canvas id="mycanvas" height="600" width="800">
    </div>
</div>


<!-- including the lib and an rgb to hsv color util function -->
<script src="pen.js"></script>
<script src="hsv.js"></script>


<script>
	var p = new Pen("mycanvas");

	// grab canvas and context reference
	var canvas = document.getElementById('mycanvas');
    var context = canvas.getContext('2d');

	var cmds = { 
		"forward": "p.go(length);",
		"forward half": "p.go(length/2);",
		"backward": "p.go(-length);",
		"backward half": "p.go(-length/2);",
		"turn around": "p.turn(180);",
		"left 90 degrees": "p.turn(-90);",
		"right 90 degrees": "p.turn(90);",
		"left 45 degrees": "p.turn(-45);",
		"right 45 degrees": "p.turn(45);",
		"left 30 degrees": "p.turn(-30);",
		"right 30 degrees": "p.turn(30);",
		"recurse": "p.turtle(depth-1,length/2);",
		"square": "p.go(length);p.turn(90);p.go(length);p.turn(90);p.go(length);p.turn(90);p.go(length);p.turn(90);",
		"triangle": "p.turn(-90);p.go(length/2);p.turn(120);p.go(length);p.turn(120);p.go(length);p.turn(120);p.go(length/2);p.turn(90);",
		"pen up": "p.penup();",
		"pen down": "p.pendown();",
		"magenta": "p.penstyle('#FF00FF');",
		"recursive tree": "p.go(length);p.turn(-45);p.turtle(depth-1,length/2);p.turn(90);p.turtle(depth-1,length/2);p.turn(-45);p.go(-length);"
	};
	
    // get refence to list of all commands
	var cmdList = document.getElementById("commandList");

	// get reference to list of commands to execute
	var cmdsToExecute = document.getElementById("selectedList").getElementsByTagName("li");

	// For IE / other platform support
    var text = "textContent" in document ? "textContent" : "innerText";

	var listElement;
	var cmdToAddValue;

	// load values of available commands list
	$.each(cmds, function(key, value) {
		listElement = document.createElement("li");
		listElement.setAttribute('class', 'draggable ui-state-default');
		cmdToAddValue = document.createTextNode(key);
		listElement.appendChild(cmdToAddValue);
		cmdList.appendChild(listElement);
	});

	// returns the current value selected by the recursion depth slider
	function getCurrentDepthValue() {
		var value = $( "#slider-range-min" ).slider( "value" );
		if (value < 0 || value > 30) {
			value = 4;
		}
		return value;
	}
	// execute the commands selected in the drag commands here list
	p.turtle = function(depth, length) {
		// base case
		if (depth <= 0) {
			return;
		}

		for (var i = 0; i < cmdsToExecute.length; i++) {
			eval(cmds[cmdsToExecute[i][text]]);
		}
	};

	function drawOnCanvas() {
		// get recursion depth value from slider
		var depth = getCurrentDepthValue();

		// set the turtle up at the origin facing north, with a clean canvas
		context.clearRect(0, 0, canvas.width, canvas.height);
		p.goto(screen.availWidth / 10, screen.availHeight / 4).fillstyle("#faf8ef").penstyle("#000");
		p.origin().angle(0).pendown();

		// start our drawing
		p.turtle(depth, 100);
		p.draw();
	}

	// draw + delay between each level of recursion
	function animateDrawOnCanvas() {
		// get recursion depth value from slider
		var depth = getCurrentDepthValue();

		context.clearRect(0, 0, canvas.width, canvas.height);
		p.goto(screen.availWidth / 10, screen.availHeight / 4).fillstyle("#faf8ef").penstyle("#000");
		p.origin().angle(0).pendown();

		(function animateLoop (i, max) {          
			setTimeout(function () {
				// start our drawing
				p.turtle(i, 100);
				p.draw();
			  	if (++i <= max) animateLoop(i, max);
		   }, 300)
		})(1, depth);
	}

	
	load = function () {
  		return JSON.parse(localStorage["recursionEditor"]);
	};
 
	save = function(obj) {
		localStorage["recursionEditor"] = JSON.stringify(obj);
	};
	
	function saveCustomDrawing() {

		// get data of current drawing into an array
		var newDrawing = [];
		$.each(cmdsToExecute, function(key, value) {
			//alert(key + " : " + value[text]);
			var obj = {key : value[text]};
			newDrawing.push(obj);
		});
		
		// push this new data onto local storage
		var data = load();
		data.push(newDrawing);
		save(data);

		loaded = load();

		// load values of available commands list
		$.each(loaded, function(key, value) {
			//alert(key + " : " + value);
		});
	}
	
</script>
</body>
</html>